<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:400; font-style:normal;">
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Одной из самых умных и мощных инноваций в UNIX является оболочка. Она эффективнее, чем графический интерфейс и позволяет создавать сценарии для автоматизации многих задач. Более того, с помощью конвейера команд можно конструировать импровизированные программы непосредственно в командной строке. Конвейер собирает команды в цепочки, в которых стандартный вывод одной команды становится стандартным вводом для следующей команды. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Но у конвейера есть один серьезный недостаток: он похож на черный ящик. Когда вы соединяете две команды, единственным признаком хода выполнения процесса является вывод, генерируемый последней в последовательности командой. Можно вставить в последовательность команду <span style=" font-family:'Courier New,courier';">tee</span>, а также наблюдать за ростом выходного файла с помощью <span style=" font-family:'Courier New,courier';">tail</span>, но эти решения отлично работают только при однократном применении в команде, в противном случае стандартные потоки вывода (<span style=" font-family:'Courier New,courier';">stdout</span>) и стандартные потоки ошибок (<span style=" font-family:'Courier New,courier';">stderr</span>) различных фаз перемешиваются. К тому же оба эти решения являются грубыми индикаторами, которые, вероятно, не покажут, сколько в действительности вычислений требуется на каждом шаге. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Конечно, можно разбить сложную последовательность команд на множество отдельных шагов, каждый из которых будет генерировать свой собственный выходной файл. В самом деле, если вы хотите проверять результат работы на каждом интервале, декомпозиция является идеальным решением. Создайте сценарий, в котором на каждом шаге генерируйте отдельный файл с данными и используйте его в качестве входных данных для следующего шага и т.д. В результате вы получите файл с итоговыми результатами. Однако такая практика плохо подходит к импровизационной природе командной строки. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">То, что нам нужно – это индикатор прогресса выполнения задачи, который можно встраивать в командную строку для измерения скорости передачи данных. В идеале хорошо было бы использовать этот индикатор повторно, чтобы сравнивать производительность на каждом шаге. Ну и, поскольку нет предела совершенству, хорошо бы, чтобы это был инструмент с открытым кодом, который бы работал с различными вариантами UNIX, такими как Linux® и Mac OS X. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Всем нашим пожеланиям удовлетворяет программа Pipe Viewer (<span style=" font-family:'Courier New,courier';">pv</span>), написанная системным администратором Эндрю Вудом (Andrew Wood) и улучшаемая на протяжении последних четырех лет многими другими разработчиками. Она позволяет заглянуть внутрь "трубопровода" командной строки. Как говорится на <a href="http://www.ivarch.com/programs/pv.shtml"><span style=" text-decoration: underline; color:#0000ff;">домашней странице проекта</span></a>, <span style=" font-family:'Courier New,courier';">pv</span> "можно вставлять в конвейер между двумя процессами для получения визуальной индикации того, как быстро передаются между ними данные, как много времени прошло и насколько близко завершение работы". Заметим, что для измерения относительной производительности можно использовать <span style=" font-family:'Courier New,courier';">pv</span> несколько раз в одной последовательности команд. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В этой статье рассказывается о том, как собрать <span style=" font-family:'Courier New,courier';">pv</span> для своей UNIX-системы и применять ее для простых и сложных комбинаций инструментов командной строки. Давайте начнем с обзора того, как процессы обмениваются друг с другом данными с помощью конвейеров. </p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="unix_pipes"></a>Конвейеры UNIX: трубопровод для процессов </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">На <a href="http://www.ibm.com/developerworks/ru/library/au-spunix_pipeviewer/index.html?S_TACT=105AGX99&S_CMP=GR01#fig1"><span style=" text-decoration: underline; color:#0000ff;">рисунке 1</span></a> показаны этапы создания конвейера, соединяющего два независимых процесса. <br /><a name="fig1"></a><span style=" font-weight:600;">Р</span><span style=" font-weight:600;">исунок 1. Создание конвейера, соединяющего два процесса </span><br /><img src="http://www.ibm.com/developerworks/ru/library/au-spunix_pipeviewer/figure1.gif" /> <br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В начале, на фазе 1, процесс-инициатор читает данные из <span style=" font-family:'Courier New,courier';">stdin</span>, выводит результат в <span style=" font-family:'Courier New,courier';">stdout</span>, а ошибки в <span style=" font-family:'Courier New,courier';">stderr</span>. <span style=" font-family:'Courier New,courier';">stdin</span>, <span style=" font-family:'Courier New,courier';">stdout</span> и <span style=" font-family:'Courier New,courier';">stderr</span> являются <span style=" font-style:italic;">файловыми дескрипторами</span>. Каждая операция, выполняемая с файловым дескриптором, например <span style=" font-family:'Courier New,courier';">open</span>, <span style=" font-family:'Courier New,courier';">read</span>, <span style=" font-family:'Courier New,courier';">write</span>, <span style=" font-family:'Courier New,courier';">rewind</span>, <span style=" font-family:'Courier New,courier';">truncate</span> или <span style=" font-family:'Courier New,courier';">close</span>, изменяет состояние файла. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Затем в фазе 2 процесс-инициатор создает конвейер. Конвейер состоит из очереди и двух файловых дескрипторов. Один нужен, чтобы помещать данные в очередь, другой - чтобы извлекать их из очереди. Конвейер представляет собой структуру данных типа FIFO (первым пришел - первым вышел). </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Сам по себе конвейер мало полезен; он предназначен для того, чтобы соединять процесс-поставщик и процесс-потребитель (данных). Поэтому процесс-инициатор в фазе 3 <span style=" font-style:italic;">ответвляет</span> или создает себе процесс, с которым будет работать в паре. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В фазе 4 (предполагая, что новый процесс является потребителем данных), исходный процесс заменят свой <span style=" font-family:'Courier New,courier';">stdout</span> дескриптором, помещающим данные в конвейер, а <span style=" font-family:'Courier New,courier';">stdin</span> только что созданного процесса - дескриптором, считывающим данные из конвейера. После этих манипуляций каждая операция <span style=" font-family:'Courier New,courier';">write</span> исходного процесса (поставщика) будет помещена в очередь и впоследствии прочитана новым процессом (потребителем). </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Фазы 1-4 иллюстрируют то, как оболочка соединяет с помощью конвейера (<span style=" font-family:'Courier New,courier';">|</span>) две утилиты одну с другой в командной строке. Заметим только, что оболочка создает для каждой утилиты новый процесс, а сама занимается управлением ходом работы. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Например, на <a href="http://www.ibm.com/developerworks/ru/library/au-spunix_pipeviewer/index.html?S_TACT=105AGX99&S_CMP=GR01#fig2"><span style=" text-decoration: underline; color:#0000ff;">рисунке 2</span></a> показано, как можно с помощью конвейеров соединить команды <span style=" font-family:'Courier New,courier';">find</span>, <span style=" font-family:'Courier New,courier';">grep</span> и <span style=" font-family:'Courier New,courier';">wc</span>, чтобы найти и подсчитать количество файлов, имена которых начинаются с буквы <span style=" font-style:italic;">a</span> в нижнем регистре. Оболочка остается независимой; вывод <span style=" font-family:'Courier New,courier';">find</span> служит входным потоком для <span style=" font-family:'Courier New,courier';">grep</span>, результат работы которого в свою очередь направляется команде <span style=" font-family:'Courier New,courier';">wc</span>. <span style=" font-family:'Courier New,courier';">wc</span> обрабатывает полученные от <span style=" font-family:'Courier New,courier';">grep</span> данные и выводит результат своей работы в <span style=" font-family:'Courier New,courier';">stdout</span>. Обычно оболочка выводит <span style=" font-family:'Courier New,courier';">stdout</span> на терминал, но его также можно перенаправить в файл. <br /><a name="fig2"></a><span style=" font-weight:600;">Р</span><span style=" font-weight:600;">исунок 2. Соединяем команды с помощью конвейеров</span><br /><img src="http://www.ibm.com/developerworks/ru/library/au-spunix_pipeviewer/figure2.gif" /> <br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Если вы хотите изучить работу двух UNIX-процессов, создайте два конвейера и переопределите файловые дескрипторы процессов так, чтобы они являлись друг для друга и поставщиком и потребителем данных. На <a href="http://www.ibm.com/developerworks/ru/library/au-spunix_pipeviewer/index.html?S_TACT=105AGX99&S_CMP=GR01#fig3"><span style=" text-decoration: underline; color:#0000ff;">рисунке 3</span></a> показан обмен данными между процессами, в котором для обоих процессов переопределяются потоки <span style=" font-family:'Courier New,courier';">stdin</span> и <span style=" font-family:'Courier New,courier';">stdout</span>. <br /><a name="fig3"></a><span style=" font-weight:600;">Р</span><span style=" font-weight:600;">исунок 3. Исследуем два UNIX-процесса</span><br /><img src="http://www.ibm.com/developerworks/ru/library/au-spunix_pipeviewer/figure3.gif" /> <br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Мы сделали краткий обзор конвейеров, теперь давайте познакомимся поближе с утилитой Pipe Viewer. </p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://www.ibm.com/developerworks/ru/library/au-spunix_pipeviewer/index.html?S_TACT=105AGX99&S_CMP=GR01#ibm-pcon"><span style=" text-decoration: underline; color:#0000ff;">В начало</span></a></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="conspicuous"></a>Pipe Viewer: примечательный конвейер </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Pipe Viewer - это приложение с открытым исходным кодом. Можно загрузить его код и собрать приложение с нуля или загрузить исполняемый файл программы из репозитория вашего дистрибутива UNIX, если он там имеется. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для самостоятельной сборки загрузите архив с последней версией исходного кода с домашней страницы проекта Pipe Viewer (см. <a href="http://www.ibm.com/developerworks/ru/library/au-spunix_pipeviewer/index.html?S_TACT=105AGX99&S_CMP=GR01#resources"><span style=" text-decoration: underline; color:#0000ff;">Ресурсы</span></a>). В сентябре 2009 года последней версией являлась 1.1.4. Распакуйте архив, перейдите в созданную директорию и выполните <span style=" font-family:'Courier New,courier';">./configure</span>, затем <span style=" font-family:'Courier New,courier';">make</span> и <span style=" font-family:'Courier New,courier';">sudo make install</span>. По умолчанию исполняемый файл программы называется <span style=" font-family:'Courier New,courier';">pv</span> и помещается в /usr/local/bin. (Чтобы просмотреть имеющиеся параметры конфигурации, выполните <span style=" font-family:'Courier New,courier';">./configure --help</span>.) В <a href="http://www.ibm.com/developerworks/ru/library/au-spunix_pipeviewer/index.html?S_TACT=105AGX99&S_CMP=GR01#list1"><span style=" text-decoration: underline; color:#0000ff;">листинге 1</span></a> показан код установки pv. <br /><a name="list1"></a><span style=" font-weight:600;">Л</span><span style=" font-weight:600;">истинг 1. Код установки Pipe Viewer</span><br /></p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" width="65%" cellspacing="0" cellpadding="0">
<tr>
<td>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">	</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">$ wget http://pipeviewer.googlecode.com/files/pv-1.1.4.tar.bz2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">$ tar xjf pv-1.1.4.tar.bz2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">$ cd pv-1.1.4</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">$ ./configure</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">$ make</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">$ sudo make install</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">$ which pv</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">/usr/local/bin/pv</span></p></td></tr></table>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Чтобы скачать исполняемый файл программы <span style=" font-family:'Courier New,courier';">pv</span> из репозитория, найдите с помощью менеджера пакетов своего дистрибутива имеющиеся пакеты по словам <span style=" font-family:'Courier New,courier';">pv</span> или <span style=" font-style:italic;">pipe viewer</span>. Например в Ubuntu 9 поиск с помощью менеджера пакетов APT дает следующий результат: </p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" width="65%" cellspacing="0" cellpadding="0">
<tr>
<td>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">$ apt-cache search part viewer</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">pv - Shell pipeline element to meter data passing through</span></p></td></tr></table>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Загрузите и установите пакет с помощью своего менеджера пакетов. В Ubuntu это делается командой <span style=" font-family:'Courier New,courier';">apt-get install</span>: </p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" width="65%" cellspacing="0" cellpadding="0">
<tr>
<td>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">$ sudo apt-get install pv</span></p></td></tr></table>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Теперь давайте опробуем <span style=" font-family:'Courier New,courier';">pv</span> в действии. В простейшем варианте использования <span style=" font-family:'Courier New,courier';">pv</span> может заменять традиционную утилиту <span style=" font-family:'Courier New,courier';">cat</span> для передачи байтов другой программе и измерения общей производительности. Например, можно использовать <span style=" font-family:'Courier New,courier';">pv</span> для отслеживания длительной операции сжатия: </p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" width="100%" cellspacing="0" cellpadding="0">
<tr>
<td>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">$ ls -lh listings.txt</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">-r--r--r--  1 supergiantrobot  staff   109M Sep  1 20:47 listings.txt</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">$ pv listings.txt | gzip &gt; listings.gz</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">96.1MB 0:00:09 [11.3MB/s] [=====================&gt;     ] 87% ETA 0:00:01</span></p></td></tr></table>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">При запуске <span style=" font-family:'Courier New,courier';">pv</span> отображает индикатор прогресса, который показывает и непрерывно обновляет различные показатели хода выполнения работы. Обычно <span style=" font-family:'Courier New,courier';">pv</span> слева направо отображает количество обработанных данных, прошедшее время, производительность в мегабайтах в секунду, а также визуальное и численное представление количества проделанной работы и оценки оставшегося времени. В приведенном выше примере обработано 96.1МБ из 109МБ, и на оставшиеся 13% файла потребуется примерно 9 секунд </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">По умолчанию <span style=" font-family:'Courier New,courier';">pv</span> отображает все индикаторы состояния, значения которых он может вычислить. Например, если входные данные <span style=" font-family:'Courier New,courier';">pv</span> не являются файлом, и не указано вручную точного размера, индикатор прогресса перемещается слева направо, чтобы отображать активность программы, но <span style=" font-family:'Courier New,courier';">pv</span> не сможет определить процент выполненной работы. Например: </p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" width="65%" cellspacing="0" cellpadding="0">
<tr>
<td>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">$ ssh faraway tar cf - projectx | pv --wait &gt; projectx.tar</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">Password:</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">4.34MB 0:00:07 [ 611kB/s] [      &lt;=&gt;                  ]</span></p></td></tr></table>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В этом примере на удаленной машине выполняется команда <span style=" font-family:'Courier New,courier';">tar</span>, результат работы которой отправляется на локальную систему в файл projectx.tar. Поскольку <span style=" font-family:'Courier New,courier';">pv</span> не может вычислить общее количество байтов, которые будут переданы, он показывает производительность, истекшее время и специальный индикатор, отображающий активность программы. Он представляет собой маленький индикатор (<span style=" font-family:'Courier New,courier';">&lt;=&gt;</span>), который перемещается слева направо по мере передачи данных. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Параметр <span style=" font-family:'Courier New,courier';">--wait</span> откладывает отображение индикатора прогресса до момента фактического получения первого байта. Здесь <span style=" font-family:'Courier New,courier';">--wait</span> полезен, так как команда <span style=" font-family:'Courier New,courier';">ssh</span> может предложить ввести пароль. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Можно включать индикаторы по своему усмотрению, указывая флаги с говорящими именами: </p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" width="65%" cellspacing="0" cellpadding="0">
<tr>
<td>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">$ ssh faraway tar cf - projectx | \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">  pv --wait --bytes &gt; projectx.tar</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">  Password:</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">   268kB </span></p></td></tr></table>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В этой команде с помощью флага <span style=" font-family:'Courier New,courier';">--bytes</span> включается отображение количества переданных байтов. Также есть параметры <span style=" font-family:'Courier New,courier';">--progress</span>, <span style=" font-family:'Courier New,courier';">--timer</span>, <span style=" font-family:'Courier New,courier';">--eta</span>, <span style=" font-family:'Courier New,courier';">--rate</span> и <span style=" font-family:'Courier New,courier';">--numeric</span>. Если вы указываете один или более из этих параметров, все оставшиеся (неуказанные) индикаторы автоматически выключаются. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Есть еще одно простое применение <span style=" font-family:'Courier New,courier';">pv</span>. Параметр <span style=" font-family:'Courier New,courier';">--rate-limit</span> может ограничивать пропускную способность. Этот параметр принимает в качестве аргументов число и суффикс, обозначающий единицу измерения. Например, <span style=" font-family:'Courier New,courier';">m</span> обозначает число мегабайтов в секунду: </p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" width="65%" cellspacing="0" cellpadding="0">
<tr>
<td>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">$ ssh faraway tar cf - projectx | \</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">  pv --wait --quiet --rate-limit 1m &gt; projectx.tar</span></p></td></tr></table>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Предыдущая команда выключает все индикаторы (<span style=" font-family:'Courier New,courier';">--quiet</span>) и ограничивает пропускную способность скоростью 1МБ/с. </p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://www.ibm.com/developerworks/ru/library/au-spunix_pipeviewer/index.html?S_TACT=105AGX99&S_CMP=GR01#ibm-pcon"><span style=" text-decoration: underline; color:#0000ff;">В начало</span></a></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="advanced_use"></a>Более сложное использование Pipe Viewer </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">До сих пор в наших примерах использовался только один экземпляр Pipe Viewer, который выступал в роли поставщика или потребителя данных в паре команд. Однако возможны и более сложные комбинации. Соблюдая некоторые условия, можно использовать несколько экземпляров <span style=" font-family:'Courier New,courier';">pv</span> в одной командной строке. А именно: необходимо с помощью параметра <span style=" font-family:'Courier New,courier';">--name</span> указать имя каждому экземпляру <span style=" font-family:'Courier New,courier';">pv</span> и включить многострочный режим с помощью параметра <span style=" font-family:'Courier New,courier';">--cursor</span>. Вместе эти два параметра создают серию именованных индикаторов, по одному индикатору на экземпляр (программы). </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Например, мы хотим отслеживать одновременно и по отдельности процессы передачи данных и их сжатия. Мы назначаем один экземпляр <span style=" font-family:'Courier New,courier';">pv</span> первой операции, и еще один - второй: </p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" width="65%" cellspacing="0" cellpadding="0">
<tr>
<td>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">$ ssh faraway tar cf - projectx | pv --wait --name ssh | \</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">  gzip | pv --wait --name gzip &gt; projectx.tgz</span></p></td></tr></table>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">После ввода пароля мы увидим,что Pipe Viewer показывает двухстрочный индикатор активности: </p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" width="65%" cellspacing="0" cellpadding="0">
<tr>
<td>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">  ssh: 4.17MB 0:00:07 [ 648kB/s] [     &lt;=&gt;             ]</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">       gzip:  592kB 0:00:06 [62.1kB/s] [   &lt;=&gt;               ]</span></p></td></tr></table>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Первая строка с надписью <span style=" font-family:'Courier New,courier';">ssh</span> показывает прогресс передачи данных. Вторая строка с надписью <span style=" font-family:'Courier New,courier';">gzip</span> показывает прогресс сжатия данных. Поскольку ни одна из команд не может определить объем данных в своей операции, на каждой строке показан объем переданных данных и индикатор активности. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Если вы знаете, или можете оценить или вычислить объем данных, обрабатываемых операцией, то можно использовать параметр <span style=" font-family:'Courier New,courier';">--size</span>. Добавив этот параметр, вы получите более подробную информацию в индикаторах прогресса. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Например, если мы хотим отслеживать прогресс большой задачи архивирования, то можно использовать другие утилиты UNIX, чтобы оценить общий размер исходных файлов. Утилита <span style=" font-family:'Courier New,courier';">df</span> может показывать статистику для целой файловой системы, а <span style=" font-family:'Courier New,courier';">du</span> может вычислить размер иерархии файлов произвольной глубины: </p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" width="65%" cellspacing="0" cellpadding="0">
<tr>
<td>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">$ tar cf - work | pv --size `du -sh work | cut -f1` &gt; work.tar</span></p></td></tr></table>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Здесь последовательность команд <span style=" font-family:'Courier New,courier';">du -sh work | cut -f1</span> выдает общий размер рабочей директории в формате, совместимом с <span style=" font-family:'Courier New,courier';">pv</span>. Команда <span style=" font-family:'Courier New,courier';">du -h</span> генерирует данные в удобочитаемом формате, например <span style=" font-style:italic;">17M</span> для 17 мегабайт, который подходит для использования с <span style=" font-family:'Courier New,courier';">pv</span>. (Команды <span style=" font-family:'Courier New,courier';">ls</span> и <span style=" font-family:'Courier New,courier';">df</span> также поддерживают параметр <span style=" font-family:'Courier New,courier';">-h</span> для вывода данных в удобочитаемом формате). Так как теперь <span style=" font-family:'Courier New,courier';">pv</span> ожидает, что через конвейер будет передано определенное количество байтов, он отображает полноценный индикатор прогресса: </p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" width="100%" cellspacing="0" cellpadding="0">
<tr>
<td>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">700kB 0:00:07 [ 100kB/s] [&gt;                    ]  4% ETA 0:02:47</span></p></td></tr></table>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">И наконец, есть еще один прием, который наверняка будет вам полезен. Помимо подсчета байтов, Pipe Viewer может визуализировать прогресс операции, подсчитывая <span style=" font-style:italic;">строки</span> данных. Если указать модификатор <span style=" font-family:'Courier New,courier';">--line-mode</span>, то <span style=" font-family:'Courier New,courier';">pv</span> обновляет индикатор прогресса каждый раз при встрече новой строки. Также можно указать параметр <span style=" font-family:'Courier New,courier';">--size</span>, тогда число будет интерпретировано как ожидаемое количество строк. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Рассмотрим пример. Команда <span style=" font-family:'Courier New,courier';">find</span> часто бывает полезной, когда нужно найти иголку в стоге сена, например, чтобы отыскать все места, где в большом количестве кода используется определенный системный вызов. В таких случаях можно воспользоваться подобной командой: </p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" width="100%" cellspacing="0" cellpadding="0">
<tr>
<td>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">$ find . -type f -name '*.c' -exec grep --files-with-match fopen \{\} \; &gt; results</span></p></td></tr></table>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Этот код находит все файлы исходного кода на <span style=" font-family:'Courier New,courier';">C</span> и возвращает имена файлов, в которых встречается строка <span style=" font-family:'Courier New,courier';">fopen</span>. Результат работы направляется в файл с именем <span style=" font-style:italic;">results</span>. Для отражения активности добавим команду <span style=" font-family:'Courier New,courier';">pv</span>: </p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" width="65%" cellspacing="0" cellpadding="0">
<tr>
<td>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">$ find . -type f -name '*.c' -exec grep --files-with-match fopen \{\} \; | \</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">  pv --line-mode &gt; results</span></p></td></tr></table>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Строковый режим феноменален, потому что многие команды UNIX, например <span style=" font-family:'Courier New,courier';">find</span>, оперируют метаданными файлов, а не их содержимым. Строковый режим идеально подходит для сценариев системного администрирования, которые копируют или сжимают большое количество файлов. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В общем, Pipe Viewer можно вставлять в командной строке и сценариях везде, где можно измерить скорость передачи данных. . Иногда требуется быть изобретательным – например, чтобы измерить скорость копирования директории, можно перейти от <span style=" font-family:'Courier New,courier';">cp -pr</span> к <span style=" font-family:'Courier New,courier';">tar</span>: </p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" width="65%" cellspacing="0" cellpadding="0">
<tr>
<td>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">$ # an equivalent of cp -pr old/somedir new</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">$ (cd old; tar cf - somedir) | pv | (cd new; tar xf - )</span></p></td></tr></table>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Также строковый режим можно использовать при работе с сетевыми утилитами, такими как <span style=" font-family:'Courier New,courier';">wget</span>, <span style=" font-family:'Courier New,courier';">curl</span> и <span style=" font-family:'Courier New,courier';">scp</span>. Например, можно использовать <span style=" font-family:'Courier New,courier';">pv</span> для отображения выполнения процесса передачи известного объема данных на удаленную машину. И, поскольку многие сетевые утилиты могут считывать входные данные из файла, можно использовать размер такого файла в качестве аргумента для параметра <span style=" font-family:'Courier New,courier';">--size</span>. </p></body></html>